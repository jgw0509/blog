# ===========================================
# Django 블로그 프로젝트 Docker Compose
# ===========================================
# 서비스 구성:
# - web: Django 애플리케이션
# - db: PostgreSQL 데이터베이스

# 프로젝트 이름 (한글 폴더명 문제 해결)
name: django-blog

services:
  # ===========================================
  # Django 웹 애플리케이션 서비스
  # ===========================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: blog_django
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      # 개발 모드: 소스 코드 실시간 반영
      - ./backend:/app/backend
      # 정적 파일 볼륨
      - static_volume:/app/backend/staticfiles
      # 미디어 파일 볼륨 (업로드된 파일)
      - media_volume:/app/backend/media
    environment:
      # Django 설정
      - SECRET_KEY=django-insecure-dev-key-change-in-production
      - DEBUG=True
      - ALLOWED_HOSTS=localhost,127.0.0.1
      # 데이터베이스 연결 설정 (PostgreSQL과 동일)
      - POSTGRES_DB=blog_db
      - POSTGRES_USER=blog_user
      - POSTGRES_PASSWORD=blog_password
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
    depends_on:
      db:
        condition: service_healthy
    networks:
      - blog_network

  # ===========================================
  # PostgreSQL 데이터베이스 서비스
  # ===========================================
  db:
    image: postgres:16
    container_name: blog_postgres
    restart: unless-stopped
    volumes:
      # 데이터베이스 데이터 영구 저장
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=blog_db
      - POSTGRES_USER=blog_user
      - POSTGRES_PASSWORD=blog_password
    # 헬스체크: Django가 DB 준비 완료 후 시작하도록 설정
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U blog_user -d blog_db" ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - blog_network

# ===========================================
# 네트워크 정의
# ===========================================
networks:
  blog_network:
    driver: bridge

# ===========================================
# 볼륨 정의
# ===========================================
volumes:
  postgres_data:
    driver: local
  static_volume:
    driver: local
  media_volume:
    driver: local
